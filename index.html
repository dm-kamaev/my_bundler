<!DOCTYPE html>
<html lang='RU'>
<head>
  <meta charset='UTF-8'>
  <title>Loader modules</title>
</head>
<body>
  <div id='log'>

  </div>
  <script>

var LIST_MODULES = {
  "/j/app_interface_reports_to_xlsx/app_interface_reports_to_xlsx.js": {
    "md5": "5c6dcf35a07c479957f273a03fc7f3a1",
    "version": 1
  },
  "/j/app_interface_select_report/app_interface_select_report.js": {
    "md5": "86137ea71c1fa848138025a68e25d700",
    "version": 1
  },
  "/j/app_interface_select_report/h_list_banks.js": {
    "md5": "78bf7371b5b82d5fe03689def5d84048",
    "version": 1
  },
  "/j/base/fn.js": {
    "md5": "e5d20c1775700b4e69f44b9ad515a454",
    "version": 1
  }
};



var loader = (function() {
  var loader = {};

  var PREFIX_VERSION = 'a';

  /**
   * _prefix - '/stat'
   * @type {[string='']}
   */
  var _prefix = '';

  /**
   * bus -list action for after download
   * @type {Array<{ src: string, make_load: function(src: string, module: any )}>}
   */
  var bus = [];


  /**
   * listen_load
   * @param  {string} src - '/j/base/fn.js'
   * @param  {fcuntion(src: string, module: any)} make_load - action after load
   */
  function listen_load(src, make_load) {
    bus.push({ src: src, make_load: make_load });
  }

  /**
   * set_prefix_for_download - set prefix for nginx static
   * @param {string} prefix
   */
  loader.set_prefix_for_download = function (prefix) {
    _prefix = prefix;
  };


  /**
   * done - action for emit event 'load'
   * @param  {string}   src '/j/base/fn.js'
   * @param  {[any]}   module
   */
  loader.done = function(src, module) {
    for (var i = 0, l = bus.length; i < l; i++) {
      var el = bus[i];
      if (!el) {
        continue;
      }
      if (el.src === src) {
        el.make_load(src, module);
        bus[i] = null;
      }
    }
    // TODO: clean bus, after length > 100
  };


  /**
   * require
   * @todo  add timeout for load module
   * @param  {string | { src: string }} what
   * @param  {function(err)} cb
   */
  loader.require = function (what, cb) {
    var src;
    if (typeof what === 'string') {
      src = what;
    }
    var describe_modules = LIST_MODULES[src];
    if (is_loaded(src)) {
      write_log('is_loaded '+src);
      return cb();
    }
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.async = true;
    // script.text = 'alert("12313123");';
    var version = describe_modules.version;
    script.setAttribute('src', _prefix+src+'?'+PREFIX_VERSION+version);
    listen_load(src, function(src, module) {
      set_loaded(src, module);
      write_log('load '+src+' '+JSON.stringify(module, null, 2));
      cb();
    });
    script.onload = function () {
      // console.log('onload');
    };
    script.onerror = function () {
      throw new Error('Fail loaded script '+src);
    };
    document.body.appendChild(script);
  };


  /**
   * set_loaded
   * @param {string} src - '/j/base/fn.js'
   */
  function set_loaded(src, module) {
    var el = LIST_MODULES[src];
    el.loaded = true;
    el.module = module;
  }


  /**
   * is_loaded
   * @param  {string}  src - '/j/base/fn.js'
   * @return {Boolean}
   */
  function is_loaded(src) {
    return LIST_MODULES[src].loaded === true;
  }


  /**
   * require_list
   * @param  {string[] | Array<{ src: string }>} list
   * @param  {function(err)} cb
   */
  loader.require_list = function (list, cb) {
    var arr = [];
    for (var i = 0, l = list.length; i < l; i++) {
      var what_load = list[i];
      arr.push((function(wl) {
        return function (cb) {
          loader.require(wl, cb);
        };
      })(what_load));
    }
    step_by_step(arr, cb);
  };


  /**
   * get - get module
   * @param  {string} src - path to module('/j/base/fn.js')
   * @throws {Error} If not found module
   * @return {any} module
   */
  loader.get = function(src) {
    var el = LIST_MODULES[src];
    if (!el || !el.module) {
      throw new Error('Not found module '+src);
    }
    return el.module;
  };


  /**
   * _step_by_step - loading via queue
   * @param  {Array<function>} f_array
   * @param  {function(err)} finish_callback
   */
  function step_by_step(f_array, finish_callback) {
    var current = 0;
    var finish = f_array.length;

    var internal_callback = function(err, data) {
      if (err) {
        finish_callback(err); // Если ошибка, взываем главный callback серии
      } else if (current < finish) { // Пока не кончился массив берем элемент массива (функцию)
        var el_array = f_array[current];
        current++;
        el_array(internal_callback, data);
      } else {
        finish_callback(null, data);
      }
    };
    internal_callback();
  }

  return loader;
}());

loader.set_prefix_for_download('./stat');

loader.require_list([ '/j/app_interface_reports_to_xlsx/app_interface_reports_to_xlsx.js', '/j/app_interface_select_report/app_interface_select_report.js', '/j/base/fn.js' ], function () {
  var fn = loader.get('/j/base/fn.js');
  var app_interface_select_report = loader.get('/j/app_interface_select_report/app_interface_select_report.js');

  write_log('MAIN: fn.map = ' + fn.map);

  app_interface_select_report.start();
});


function write_log(str) {
  var $log = document.createElement('div');
  $log.innerHTML = str;
  $log.style = 'margin-top:20px';
  document.getElementById('log').appendChild($log);
}

// loader.require_list([ '/j/app_interface_reports_to_xlsx/app_interface_reports_to_xlsx1.js', '/j/app_interface_select_report/app_interface_select_report.js' ], function () {
//   console.log('LOADED ALL');
// });

// loader.require('/j/app_interface_reports_to_xlsx/app_interface_reports_to_xlsx.js', function () {
//   console.log('script.onload');
//   loader.require('/j/app_interface_select_report/app_interface_select_report.js', function () {
//     console.log('script.onload');
//     loader.require('/j/app_interface_select_report/app_interface_select_report.js', function () {
//       console.log('script.onload');
//     });
//   });
// });
  </script>
</body>
</html>